name: ESP8266 firmware platform.ini

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Clone external repository
      run: |
        git clone https://github.com/xiv3r/ESP8266-ESP32-8x8-relay-auto-switch.git
        mkdir -p repository
        mv ESP8266-ESP32-8x8-relay-auto-switch/* repository/
        cd repository
    
    - name: Install PlatformIO
      run: pip install platformio
    
    - name: Build firmware
      run: |
        cd repository
        # Create PlatformIO project
        platformio init --board nodemcuv2
        
        # Create platformio.ini with library dependencies
        cat > platformio.ini << EOF
        [env:nodemcuv2]
        platform = espressif8266
        board = nodemcuv2
        framework = arduino
        lib_deps = 
        bblanchon/ArduinoJson @ ^7.3.0
        EOF
        
        # Create src directory and copy the ino file
        mkdir -p src
        if [ -f "ESP8266_Relay_Controller/ESP8266_Relay_Controller.ino" ]; then
          cp ESP8266_Relay_Controller/ESP8266_Relay_Controller.ino src/
        elif [ -f "ESP8266_Relay_Controller.ino" ]; then
          cp ESP8266_Relay_Controller.ino src/
        else
          echo "Searching for .ino files..."
          find . -name "*.ino" -type f -exec cp {} src/ \;
        fi
        
        # Rename .ino to .cpp for PlatformIO
        if [ -f "src/ESP8266_Relay_Controller.ino" ]; then
          mv src/ESP8266_Relay_Controller.ino src/main.cpp
        fi
        
        # Build the firmware
        platformio run
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: built-firmware
        path: repository/.pio/build/nodemcuv2/firmware.bin
        if-no-files-found: error
