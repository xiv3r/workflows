name: Build Kali Linux ARM64 Rootfs

on:
  workflow_dispatch:
  push:
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: debian:bookworm-slim
      options: --privileged
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y debootstrap qemu-user-static tar gzip
    
    - name: Build rootfs
      run: |
        # Create rootfs
        debootstrap \
          --arch=arm64 \
          --variant=minbase \
          --include=kali-linux-core \
          kali-rolling \
          /kali-rootfs \
          http://http.kali.org/kali
        
        # Clean up
        rm -rf /kali-rootfs/var/cache/apt/archives/*
        rm -rf /kali-rootfs/var/lib/apt/lists/*
        
        # Get version
        if [ -n "${GITHUB_REF_NAME}" ]; then
          VERSION="${GITHUB_REF_NAME#v}"
        else
          VERSION="$(date +'%Y.%m.%d')"
        fi
        
        # Create tarball
        FILENAME="kali-linux-arm64-minimal-${VERSION}.tar.gz"
        tar -czf "${FILENAME}" -C /kali-rootfs .
        
        echo "FILENAME=${FILENAME}" >> $GITHUB_ENV
        echo "VERSION=${VERSION}" >> $GITHUB_ENV
        
        ls -lh "${FILENAME}"
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      if: startsWith(github.ref, 'refs/tags/')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: Kali Linux ARM64 Minimal ${{ env.VERSION }}
        files: ${{ env.FILENAME }}
        draft: false
        prerelease: false
    
    - name: Upload build artifact
      uses: actions/upload-artifact@v4
      with:
        name: kali-arm64-rootfs
        path: ${{ env.FILENAME }}
