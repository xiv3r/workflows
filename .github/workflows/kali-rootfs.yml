name: Build Kali ARM64 Rootfs

on:
  workflow_dispatch:
  push:
    tags: ['v*']

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Install multiarch support
      run: |
        # Update and install packages
        sudo apt-get update
        sudo apt-get install -y \
          qemu-user-static \
          binfmt-support \
          debootstrap \
          proot \
          tar \
          gzip
        
        # Register ARM64
        sudo update-binfmts --enable qemu-aarch64
    
    - name: Build rootfs with proot (no chroot needed)
      run: |
        # Create directory
        mkdir -p kali-rootfs
        
        # Build rootfs using debootstrap with qemu
        sudo debootstrap \
          --arch=arm64 \
          --foreign \
          --variant=minbase \
          kali-rolling \
          kali-rootfs \
          http://http.kali.org/kali
        
        # Copy qemu-aarch64-static into rootfs
        sudo cp /usr/bin/qemu-aarch64-static kali-rootfs/usr/bin/
        
        # Second stage debootstrap
        sudo chroot kali-rootfs /debootstrap/debootstrap --second-stage
        
        # Clean up
        sudo rm -f kali-rootfs/usr/bin/qemu-aarch64-static
        sudo rm -rf kali-rootfs/var/cache/apt/archives/*
        sudo rm -rf kali-rootfs/var/lib/apt/lists/*
        
        # Get version
        if [ -n "${{ github.ref_name }}" ]; then
          VERSION="${{ github.ref_name }}"
        else
          VERSION="build-$(date +'%Y%m%d-%H%M%S')"
        fi
        
        FILENAME="kali-linux-arm64-minimal-${VERSION}.tar.gz"
        
        # Create tarball
        sudo tar -czf "${FILENAME}" -C kali-rootfs .
        sudo chown $USER:$USER "${FILENAME}"
        
        echo "FILENAME=${FILENAME}" >> $GITHUB_ENV
        echo "VERSION=${VERSION}" >> $GITHUB_ENV
        
        ls -lh "${FILENAME}"
        echo "File created: ${FILENAME}"
    
    - name: Create Release
      uses: ncipollo/release-action@v1
      if: startsWith(github.ref, 'refs/tags/')
      with:
        tag: ${{ github.ref_name }}
        name: Kali Linux ARM64 ${{ env.VERSION }}
        artifacts: ${{ env.FILENAME }}
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: kali-rootfs
        path: ${{ env.FILENAME }}
